version: '3.8'

services:
  # SpriteMancer Backend (Python/FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: spritemancer-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - UPSTASH_REDIS_URL=${UPSTASH_REDIS_URL}
      - UPSTASH_REDIS_TOKEN=${UPSTASH_REDIS_TOKEN}
      - CORS_ORIGINS=["https://spritemancer.zerograft.online","https://api.zerograft.online"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - spritemancer-net

  # SpriteMancer Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=https://api.zerograft.online
        - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    container_name: spritemancer-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=https://api.zerograft.online
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    depends_on:
      - backend
    networks:
      - spritemancer-net

  # Gemini Proxy (rate-limited API access)
  gemini-proxy:
    build:
      context: ./gemini-proxy
      dockerfile: Dockerfile
    container_name: gemini-proxy
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - RATE_LIMIT_REQUESTS=1000
      - RATE_LIMIT_WINDOW_SECONDS=3600
      - DAILY_LIMIT=5000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - spritemancer-net

  # AI Router (Agentic Godot)
  ai-router:
    build:
      context: ./ai-router
      dockerfile: Dockerfile
    container_name: ai-router
    restart: unless-stopped
    ports:
      - "9877:9877"
      - "9878:9878"
    environment:
      - GEMINI_API_KEY=proxy-managed
      - GEMINI_PROXY_URL=http://gemini-proxy:8001
      - GEMINI_MODEL=gemini-3-flash-preview
      - AI_ROUTER_PORT=9877
      - AI_ROUTER_WS_PORT=9878
      - GODOT_BRIDGE_HOST=0.0.0.0
      - GODOT_BRIDGE_PORT=9876
    depends_on:
      - gemini-proxy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9877/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - spritemancer-net

  # Caddy reverse proxy (auto-HTTPS)
  caddy:
    image: caddy:2-alpine
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - backend
      - frontend
      - gemini-proxy
    networks:
      - spritemancer-net

networks:
  spritemancer-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
